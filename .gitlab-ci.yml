image: node:10


stages:
  - test
  - build


.yarn: &yarn
  before_script:
    - apt-get update
    - apt-get install nasm
    - yarn --pure-lockfile
  script:
    - yarn run $CI_JOB_NAME


build:app:
  <<: *yarn
  artifacts:
    paths:
      - dist/


build:docker:
  stage: build
  image: dind
  dependencies:
    - build:app
  script:
    - docker build .


eslint: *yarn


pages:
  stage: deploy
  image: alpine
  dependencies:
    - test
  only:
    - master
  script:
    - mv coverage/lcov-report public
  artifacts:
    paths:
      - public/


stylelint: *yarn


test:
  <<: *yarn
  script:
    - yarn test --coverage
  artifacts:
    paths:
      - coverage/
