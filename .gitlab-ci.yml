image: node:10-slim

stages:
  - test
  - build
  - publish
  - deploy
  - provision

###################################################################################################
#  Test Stage                                                                                     #
###################################################################################################

# Scan for dependency vulnerabilities.
dependency scanning:
  allow_failure: true
  script:
    - yarn --frozen-lockfile
    - yarn gitlab-yarn-audit
  artifacts:
    reports:
      dependency_scanning: gl-dependency-scanning.json

# Lint JavaScript code using ESLint.
eslint:
  except:
    - schedules
  script:
    - yarn --frozen-lockfile
    - yarn eslint
  artifacts:
    reports:
      codequality: gl-codequality.json

# Check formatting using prettier.
prettier:
  except:
    - schedules
  script:
    - yarn --frozen-lockfile
    - yarn prettier

# Lint CSS using stylelint.
stylelint:
  except:
    - schedules
  script:
    - yarn --frozen-lockfile
    - yarn stylelint
      # This replaces the regular stylelint behaviour, instead of enhancing it.
      # https://github.com/stylelint/stylelint/issues/2369
    - yarn stylelint:rd

# Test the code using unit tests.
test:
  services:
    - name: mysql:8
      command: [--default-authentication-plugin=mysql_native_password]
  except:
    - schedules
  variables:
    MYSQL_DATABASE: testAppsemble
    MYSQL_ROOT_PASSWORD: password
    DATABASE_URL: 'mysql://root:password@mysql:3306'
  script:
    - yarn --frozen-lockfile
    - yarn jest --coverage --reporters default --reporters jest-junit
  artifacts:
    reports:
      junit: junit.xml

# Check type validity for our TypeScript files.
tsc:
  except:
    - schedules
  script:
    - yarn --frozen-lockfile
    - yarn tsc --noEmit

###################################################################################################
#  Build Stage                                                                                    #
###################################################################################################

# Build Appsemble blocks.
build blocks:
  stage: build
  except:
    - schedules
  dependencies: []
  script:
    - yarn --frozen-lockfile
    - yarn block action
    - yarn block action-button
    - yarn block detail-viewer
    - yarn block list
    - yarn block feed
    - yarn block filter
    - yarn block form
    - yarn block map
    - yarn block markdown
    - yarn block splash
  artifacts:
    expire_in: 3 days
    paths:
      - blocks/action/package.json
      - blocks/action/dist/
      - blocks/action/.appsemblerc.yaml
      - blocks/action-button/dist/
      - blocks/action-button/package.json
      - blocks/detail-viewer/dist/
      - blocks/detail-viewer/package.json
      - blocks/list/dist/
      - blocks/list/package.json
      - blocks/list/.appsemblerc.yaml
      - blocks/feed/package.json
      - blocks/feed/dist/
      - blocks/feed/.appsemblerc.yaml
      - blocks/filter/package.json
      - blocks/filter/dist/
      - blocks/filter/.appsemblerc.yaml
      - blocks/form/dist/
      - blocks/form/package.json
      - blocks/map/dist/
      - blocks/map/package.json
      - blocks/markdown/package.json
      - blocks/markdown/dist/
      - blocks/markdown/.appsemblerc.yaml
      - blocks/splash/dist/
      - blocks/splash/package.json

# Build the Docker image.
build docker image:
  stage: build
  except:
    - schedules
  dependencies: []
  services:
    - docker:dind
  image: docker
  script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - docker build -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME" .
    - docker push "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME"

# Build the Docker image.
build docs image:
  stage: build
  except:
    - schedules
  dependencies: []
  services:
    - docker:dind
  image: docker
  script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - docker build -f config/docs/Dockerfile -t "$CI_REGISTRY_IMAGE/docs:$CI_COMMIT_REF_NAME" .
    - docker push "$CI_REGISTRY_IMAGE/docs:$CI_COMMIT_REF_NAME"

# Build the npm packages that should be published.
pack:
  stage: build
  except:
    - schedules
  dependencies: []
  script:
    - yarn workspace @appsemble/cli pack
    - yarn workspace @appsemble/node-utils pack
    - yarn workspace @appsemble/react pack
    - yarn workspace @appsemble/sdk pack
    - yarn workspace @appsemble/server pack
    - yarn workspace create-appsemble pack
  artifacts:
    paths:
      - packages/**/*.tgz

###################################################################################################
#  Publish Stage                                                                                  #
###################################################################################################

# Publish the Docker image that was built to Docker Hub.
publish:docker:latest:
  stage: publish
  services:
    - docker:dind
  image: docker
  variables:
    GIT_STRATEGY: none
  only:
    - tags
  except:
    - schedules
  dependencies: []
  script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - echo $DOCKER_HUB_PASSWORD | docker login -u $DOCKER_HUB_USER --password-stdin
    - docker pull "$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG"
    - docker tag "$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG" "$CI_REGISTRY_IMAGE:latest"
    - docker tag "$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG" "appsemble/appsemble:latest"
    - docker tag "$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG" "appsemble/appsemble:$CI_COMMIT_TAG"
    - docker push "$CI_REGISTRY_IMAGE:latest"
    - docker push "appsemble/appsemble:latest"
    - docker push "appsemble/appsemble:$CI_COMMIT_TAG"

###################################################################################################
#  Deploy Stage                                                                                   #
###################################################################################################

# Deploy the Docker image for a branch to a review environment.
review:
  stage: deploy
  when: manual
  except:
    - master
    - schedules
  dependencies: []
  allow_failure: false
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    url: https://$CI_ENVIRONMENT_SLUG.appsemble.app
    on_stop: stop review
  script:
    - yarn --frozen-lockfile
    # This allows passing these variables for use in later stages.
    - yarn appsemble config set email bot@appsemble.com
    - yarn appsemble config set password "$(openssl rand -base64 12)"
    - yarn appsemble config set remote "$CI_ENVIRONMENT_URL"
    - node -r esm config/bin/deploy.js
  artifacts:
    expire_in: 1 day
    paths:
      - package.json

# Stop a review environment.
stop review:
  stage: deploy
  when: manual
  except:
    - master
    - schedules
  dependencies: []
  environment:
    name: review/$CI_COMMIT_REF_SLUG
    action: stop
  script:
    - yarn --frozen-lockfile
    - node -r esm config/bin/stop.js

# Deploy the Docker image for a branch to a review environment.
review docs:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/gitlab-build-images:gitlab-charts-build-base
  when: manual
  except:
    - master
    - schedules
  dependencies: []
  allow_failure: false
  environment:
    name: review/docs/$CI_COMMIT_REF_SLUG
    url: https://$CI_ENVIRONMENT_SLUG.appsemble.app
    on_stop: stop review docs
  script:
    - mkdir ~/.helm
    - kubectl get secrets/tiller-secret -n gitlab-managed-apps -o "jsonpath={.data['tls\.crt']}" | base64 -d > ~/.helm/cert.pem
    - kubectl get secrets/tiller-secret -n gitlab-managed-apps -o "jsonpath={.data['tls\.key']}" | base64 -d > ~/.helm/key.pem
    - helm init --client-only
    - helm upgrade "$CI_ENVIRONMENT_SLUG" config/charts/appsemble-docs
      --install
      --wait
      --reset-values
      --set "host=$CI_ENVIRONMENT_SLUG.appsemble.app"
      --set "ingress.tls.secretName=$CI_COMMIT_REF_SLUG-tls"
      --set "image.tag=$CI_COMMIT_REF_NAME"

# Stop a review environment.
stop review docs:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/gitlab-build-images:gitlab-charts-build-base
  when: manual
  except:
    - master
    - schedules
  dependencies: []
  environment:
    name: review/docs/$CI_COMMIT_REF_SLUG
    action: stop
  script:
    - mkdir ~/.helm
    - kubectl get secrets/tiller-secret -n gitlab-managed-apps -o "jsonpath={.data['tls\.crt']}" | base64 -d > ~/.helm/cert.pem
    - kubectl get secrets/tiller-secret -n gitlab-managed-apps -o "jsonpath={.data['tls\.key']}" | base64 -d > ~/.helm/key.pem
    - helm init --client-only
    - helm delete --purge "$CI_ENVIRONMENT_SLUG"

# Deploy the Docker image for master to the staging environment.
staging:
  stage: deploy
  only:
    - master@appsemble/appsemble
  except:
    - schedules
  dependencies: []
  environment:
    name: review/master
    url: https://staging.appsemble.app
    on_stop: stop staging
  script:
    - yarn --frozen-lockfile
    # This allows passing the CI_ENVIRONMENT_URL for use in later stages.
    - yarn appsemble config set email bot@appsemble.com
    - yarn appsemble config set password "$(openssl rand -base64 12)"
    - yarn appsemble config set remote "$CI_ENVIRONMENT_URL"
    - node -r esm config/bin/deploy.js
  artifacts:
    expire_in: 1 day
    paths:
      - package.json

# Stop the staging environment.
stop staging:
  stage: deploy
  when: manual
  only:
    - master@appsemble/appsemble
  except:
    - schedules
  dependencies: []
  environment:
    name: review/master
    action: stop
  script:
    - yarn --frozen-lockfile
    - node -r esm config/bin/stop.js

###################################################################################################
#  Provision Stage                                                                                #
###################################################################################################

# Provision the live environment with the blocks that were built in the build stage.
upload blocks:
  stage: provision
  except:
    - schedules
  dependencies:
    - build blocks
    - pack
    - review
    - staging
  variables:
    GIT_STRATEGY: none
  script:
    - npm install ./packages/node-utils/*.tgz
    - npm install ./packages/cli/*.tgz
    - yarn appsemble login
    - yarn appsemble block register --ignore-conflict blocks/action
    - yarn appsemble block register --ignore-conflict blocks/action-button
    - yarn appsemble block register --ignore-conflict blocks/detail-viewer
    - yarn appsemble block register --ignore-conflict blocks/list
    - yarn appsemble block register --ignore-conflict blocks/feed
    - yarn appsemble block register --ignore-conflict blocks/filter
    - yarn appsemble block register --ignore-conflict blocks/form
    - yarn appsemble block register --ignore-conflict blocks/map
    - yarn appsemble block register --ignore-conflict blocks/markdown
    - yarn appsemble block register --ignore-conflict blocks/splash
