image: node:10-alpine


stages:
  - test
  - deploy


.yarn: &yarn
  before_script:
    - 'apk add --update --no-cache
        autoconf
        automake
        bash
        g++
        gcc
        lcms2-dev
        libpng-dev
        make'
    - yarn --pure-lockfile
  script:
    - yarn run $CI_JOB_NAME


build:
  <<: *yarn
  artifacts:
    paths:
      - dist/


deploy master:
  stage: deploy
  image: registry.gitlab.com/appsemble/docker/gcloud-deploy
  dependencies:
    - build
  only:
    - master
  environment:
    name: staging
    url: https://amsterdam-dot-appsemble-staging.appspot.com
  before_script:
    - activate-service-account
  script:
    - gcloud app deploy app.yaml
        --version $CI_COMMIT_SHA
        --promote
        --stop-previous-version


eslint: *yarn


pages:
  stage: deploy
  image: alpine
  dependencies:
    - test
  only:
    - master
  script:
    - mv coverage/lcov-report public


stylelint: *yarn


test:
  <<: *yarn
  script:
    - yarn test --coverage
  artifacts:
    paths:
      - coverage/
